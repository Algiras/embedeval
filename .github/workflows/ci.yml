name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

permissions:
  contents: write
  pages: write

env:
  # Color codes for pretty output
  RED: '\033[0;31m'
  GREEN: '\033[0;32m'
  YELLOW: '\033[1;33m'
  BLUE: '\033[0;34m'
  PURPLE: '\033[0;35m'
  CYAN: '\033[0;36m'
  NC: '\033[0m' # No Color
  BOLD: '\033[1m'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸš€ Starting Build
      run: |
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘   ğŸš€ EmbedEval v2 CI/CD Pipeline      â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo -e "${CYAN}${BOLD}â†’ Installing dependencies...${NC}"
        npm install
        echo -e "${GREEN}âœ… Dependencies installed${NC}"
    
    - name: ğŸ” Type check
      run: |
        echo -e "${CYAN}${BOLD}â†’ Running TypeScript type check...${NC}"
        npm run typecheck
        echo -e "${GREEN}âœ… Type check complete${NC}"
    
    - name: ğŸ§¹ Lint
      run: |
        echo -e "${CYAN}${BOLD}â†’ Running ESLint...${NC}"
        npm run lint
        echo -e "${GREEN}âœ… Lint complete${NC}"
    
    - name: ğŸ§ª Run Unit Tests
      run: |
        echo -e "${CYAN}${BOLD}â†’ Running unit tests...${NC}"
        npm test
        echo -e "${GREEN}âœ… Tests complete${NC}"
    
    - name: ğŸ—ï¸ Build
      run: |
        echo -e "${CYAN}${BOLD}â†’ Building TypeScript...${NC}"
        npm run build
        echo -e "${GREEN}âœ… Build successful${NC}"
        echo -e "${PURPLE}ğŸ“¦ Generated $(find dist -name '*.js' | wc -l) JavaScript files${NC}"
    
    - name: ğŸ§ª Test v2 CLI commands
      run: |
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘       ğŸ§ª Testing EmbedEval v2 CLI      â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        # Test 1: collect command
        echo -e "${CYAN}${BOLD}â†’ Test 1: collect command${NC}"
        node dist/cli/index.js collect examples/v2/sample-traces.jsonl --output test-traces.jsonl
        if [ ! -f test-traces.jsonl ]; then
          echo -e "${RED}âŒ FAIL: collect command did not create output file${NC}"
          exit 1
        fi
        count=$(wc -l < test-traces.jsonl)
        if [ "$count" -ne 3 ]; then
          echo -e "${RED}âŒ FAIL: Expected 3 traces, got $count${NC}"
          exit 1
        fi
        echo -e "${GREEN}âœ… PASS: collect command works (${count} traces)${NC}"
        echo ""
        
        # Test 2: view command (dry run - just check it doesn't crash)
        echo -e "${CYAN}${BOLD}â†’ Test 2: view command${NC}"
        timeout 5 node dist/cli/index.js view test-traces.jsonl || true
        echo -e "${GREEN}âœ… PASS: view command runs${NC}"
        echo ""
        
        # Test 3: taxonomy build
        echo -e "${CYAN}${BOLD}â†’ Test 3: taxonomy build${NC}"
        echo '{"id":"ann-001","traceId":"trace-001","annotator":"ci@test.com","timestamp":"2026-01-30T10:00:00Z","label":"fail","failureCategory":"hallucination","notes":"Test","source":"manual"}' > test-annotations.jsonl
        node dist/cli/index.js taxonomy build \
          --annotations test-annotations.jsonl \
          --user "ci@test.com" \
          --output test-taxonomy.json
        if [ ! -f test-taxonomy.json ]; then
          echo -e "${RED}âŒ FAIL: taxonomy build did not create output file${NC}"
          exit 1
        fi
        echo -e "${GREEN}âœ… PASS: taxonomy build works${NC}"
        echo ""
        
        # Test 4: taxonomy show
        echo -e "${CYAN}${BOLD}â†’ Test 4: taxonomy show${NC}"
        node dist/cli/index.js taxonomy show --taxonomy test-taxonomy.json > /dev/null
        echo -e "${GREEN}âœ… PASS: taxonomy show works${NC}"
        echo ""
        
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘   ğŸ‰ All v2 CLI tests passed!         â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build
        path: |
          dist/
          examples/v2/
        retention-days: 5

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ“„ Verify documentation
      run: |
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘   ğŸ“„ Verifying Documentation          â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Checking docs structure...${NC}"
        ls -la docs/
        echo -e "${GREEN}âœ… Documentation ready${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Verifying index.html...${NC}"
        head -20 docs/index.html
        echo -e "${GREEN}âœ… index.html verified${NC}"
    
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages

  publish-npm:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo -e "${CYAN}${BOLD}â†’ Installing dependencies...${NC}"
        npm install
        echo -e "${GREEN}âœ… Dependencies installed${NC}"
    
    - name: ğŸ—ï¸ Build
      run: |
        echo -e "${CYAN}${BOLD}â†’ Building for production...${NC}"
        npm run build
        echo -e "${GREEN}âœ… Build successful${NC}"
    
    - name: ğŸ” Verify CLI
      run: |
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘   ğŸ” Pre-Publish Verification          â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Checking package.json bin entry...${NC}"
        cat package.json | grep -A 2 '"bin"'
        echo -e "${GREEN}âœ… Bin entry verified${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Verifying CLI is executable...${NC}"
        head -1 dist/cli/index.js | grep "#!/usr/bin/env node"
        echo -e "${GREEN}âœ… CLI shebang verified${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Testing CLI version...${NC}"
        VERSION=$(node dist/cli/index.js --version)
        echo -e "${GREEN}âœ… CLI working - Version: ${BOLD}$VERSION${NC}"
    
    - name: ğŸš€ Publish to NPM
      run: |
        echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}${BOLD}â•‘   ğŸš€ Publishing to NPM Registry        â•‘${NC}"
        echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "${CYAN}${BOLD}â†’ Publishing embedeval...${NC}"
        echo -e "${YELLOW}âš ï¸  Note: Requires NPM_PUBLISH_KEY secret${NC}"
        
        npm publish --access public
        
        echo ""
        echo -e "${GREEN}${BOLD}âœ… Successfully published to NPM!${NC}"
        echo -e "${PURPLE}ğŸ“¦ Package: https://www.npmjs.com/package/embedeval${NC}"
        echo ""
        echo -e "${CYAN}ğŸ’¡ Users can now install via:${NC}"
        echo -e "   npm install -g embedeval"
        echo -e "   # or"
        echo -e "   npx embedeval --help"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_KEY }}
