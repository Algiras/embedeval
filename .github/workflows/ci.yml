name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm install
    
    - name: Type check
      run: npm run typecheck 2>&1 | head -30 || true
      continue-on-error: true
    
    - name: Lint
      run: npm run lint 2>&1 | head -30 || true
      continue-on-error: true
    
    - name: Build
      run: npm run build
    
    - name: Test v2 CLI commands
      run: |
        echo "=== Testing EmbedEval v2 CLI ==="
        
        # Test 1: collect command
        echo "→ Testing: collect"
        node dist/cli/index.js collect examples/v2/sample-traces.jsonl --output test-traces.jsonl
        if [ ! -f test-traces.jsonl ]; then
          echo "❌ FAIL: collect command did not create output file"
          exit 1
        fi
        count=$(wc -l < test-traces.jsonl)
        if [ "$count" -ne 3 ]; then
          echo "❌ FAIL: Expected 3 traces, got $count"
          exit 1
        fi
        echo "✅ PASS: collect command works"
        
        # Test 2: view command (dry run - just check it doesn't crash)
        echo "→ Testing: view (dry run)"
        timeout 5 node dist/cli/index.js view test-traces.jsonl || true
        echo "✅ PASS: view command runs"
        
        # Test 3: taxonomy build
        echo "→ Testing: taxonomy build"
        echo '{"id":"ann-001","traceId":"trace-001","annotator":"ci@test.com","timestamp":"2026-01-30T10:00:00Z","label":"fail","failureCategory":"hallucination","notes":"Test","source":"manual"}' > test-annotations.jsonl
        node dist/cli/index.js taxonomy build \
          --annotations test-annotations.jsonl \
          --user "ci@test.com" \
          --output test-taxonomy.json
        if [ ! -f test-taxonomy.json ]; then
          echo "❌ FAIL: taxonomy build did not create output file"
          exit 1
        fi
        echo "✅ PASS: taxonomy build works"
        
        # Test 4: taxonomy show
        echo "→ Testing: taxonomy show"
        node dist/cli/index.js taxonomy show --taxonomy test-taxonomy.json > /dev/null
        echo "✅ PASS: taxonomy show works"
        
        echo ""
        echo "=== All v2 CLI tests passed! ==="
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build
        path: |
          dist/
          examples/v2/
        retention-days: 5

  publish-npm:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build
      run: npm run build
    
    - name: Verify CLI
      run: |
        # Check that bin entry is correct
        cat package.json | grep -A 2 '"bin"'
        
        # Verify CLI is executable
        head -1 dist/cli/index.js | grep "#!/usr/bin/env node"
        
        # Test CLI works
        node dist/cli/index.js --version
    
    - name: Publish to NPM
      run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_KEY }}

  update-github-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
